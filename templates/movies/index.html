<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CineVerse - Movie Dashboard</title>
    <meta name="description" content="Browse and discover movies from your collection">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/movies/styles.css">
</head>

<body>
    <header class="site-header">
        <div class="header-content">
            <h1 class="logo">üé¨ CineVerse</h1>
            <p class="subtitle">{{ collection_count }} movies in your collection</p>
        </div>
    </header>

    <main class="main">
        <div class="filter-panel">
            <div class="search-row">
                <div class="search-container">
                    <input id="searchBox" type="search" class="search-input"
                        placeholder="Search movies by title or year..." value="{{ query|default:'' }}"
                        autocomplete="off">
                    <span class="search-icon">üîç</span>
                </div>
            </div>

            <div class="filter-row">
                <div class="filter-group">
                    <label for="yearFrom">Year</label>
                    <div class="filter-range">
                        <select id="yearFrom" name="year_from" class="filter-select">
                            <option value="">From</option>
                            {% for y in years %}
                            <option value="{{ y }}">{{ y }}</option>
                            {% endfor %}
                        </select>
                        <span class="range-sep">‚Äì</span>
                        <select id="yearTo" name="year_to" class="filter-select">
                            <option value="">To</option>
                            {% for y in years %}
                            <option value="{{ y }}">{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="filter-group">
                    <label for="minRating">Rating</label>
                    <select id="minRating" name="min_rating" class="filter-select">
                        <option value="">Any</option>
                        {% for val, label in rating_options %}
                        <option value="{{ val }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group genre-filter">
                    <label>Genre</label>
                    <div class="genre-dropdown">
                        <button type="button" class="genre-btn filter-select" id="genreDropdownBtn">
                            <span id="genreLabel">All Genres</span>
                            <span class="dropdown-arrow">‚ñº</span>
                        </button>
                        <div class="genre-menu" id="genreMenu" hidden>
                            {% for genre in genre_options %}
                            <label class="genre-option">
                                <input type="checkbox" name="genres" value="{{ genre }}" class="genre-checkbox">
                                <span>{{ genre }}</span>
                            </label>
                            {% empty %}
                            <p class="genre-empty">No genres available</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="filter-group">
                    <label for="sortBy">Sort</label>
                    <select id="sortBy" name="sort" class="filter-select">
                        {% for val, label in sort_options %}
                        <option value="{{ val }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <button id="clearFilters" class="btn-clear" type="button">Clear All</button>
            </div>
        </div>

        <div class="results-info" id="resultsInfo">
            <span id="resultsCount">Showing {{ total_count }} movie{{ total_count|pluralize }}</span>
        </div>

        <div id="movieGrid" class="grid">
            {% include 'movies/_movie_cards.html' %}
        </div>

        {% if movies.has_other_pages %}
        <nav class="pagination" aria-label="Movie pagination">
            {% if movies.has_previous %}
            <a href="?page=1" class="page-link" aria-label="First">¬´</a>
            <a href="?page={{ movies.previous_page_number }}" class="page-link" aria-label="Previous">‚Äπ</a>
            {% endif %}
            <span class="page-info">Page {{ movies.number }} of {{ movies.paginator.num_pages }}</span>
            {% if movies.has_next %}
            <a href="?page={{ movies.next_page_number }}" class="page-link" aria-label="Next">‚Ä∫</a>
            <a href="?page={{ movies.paginator.num_pages }}" class="page-link" aria-label="Last">¬ª</a>
            {% endif %}
        </nav>
        {% endif %}
    </main>

    <div id="movieModal" class="modal" hidden>
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <button class="modal-close" aria-label="Close">√ó</button>
            <div id="modalBody" class="modal-body">
                <div class="loading-spinner"></div>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const searchBox = document.getElementById('searchBox');
            const yearFrom = document.getElementById('yearFrom');
            const yearTo = document.getElementById('yearTo');
            const minRating = document.getElementById('minRating');
            const sortBy = document.getElementById('sortBy');
            const clearBtn = document.getElementById('clearFilters');
            const grid = document.getElementById('movieGrid');

            // Genre multi-select elements
            const genreDropdownBtn = document.getElementById('genreDropdownBtn');
            const genreMenu = document.getElementById('genreMenu');
            const genreLabel = document.getElementById('genreLabel');
            const genreCheckboxes = document.querySelectorAll('input[name="genres"]');

            let debounceTimer;

            function getSelectedGenres() {
                const selected = [];
                genreCheckboxes.forEach(cb => {
                    if (cb.checked) selected.push(cb.value);
                });
                return selected;
            }

            function updateGenreLabel() {
                const selected = getSelectedGenres();
                if (selected.length === 0) {
                    genreLabel.textContent = 'All Genres';
                } else if (selected.length === 1) {
                    genreLabel.textContent = selected[0];
                } else {
                    genreLabel.textContent = selected.length + ' genres';
                }
            }

            function buildQueryString() {
                const params = new URLSearchParams();
                if (searchBox && searchBox.value.trim()) params.set('q', searchBox.value.trim());
                if (yearFrom && yearFrom.value) params.set('year_from', yearFrom.value);
                if (yearTo && yearTo.value) params.set('year_to', yearTo.value);
                if (minRating && minRating.value) params.set('min_rating', minRating.value);
                if (sortBy && sortBy.value) params.set('sort', sortBy.value);
                // Add multiple genres
                getSelectedGenres().forEach(g => params.append('genres', g));
                return params.toString();
            }

            function updateMovies() {
                const qs = buildQueryString();
                if (grid) grid.classList.add('loading');
                const resultsCount = document.getElementById('resultsCount');

                fetch('/search_ajax/?' + qs)
                    .then(r => r.json())
                    .then(data => {
                        if (grid) {
                            grid.innerHTML = data.html;
                            grid.classList.remove('loading');
                        }
                        if (resultsCount) {
                            const count = data.count;
                            resultsCount.textContent = 'Showing ' + count + ' movie' + (count !== 1 ? 's' : '');
                        }
                        const newUrl = qs ? '?' + qs : window.location.pathname;
                        history.replaceState(null, '', newUrl);
                    })
                    .catch(err => {
                        console.error('Search error:', err);
                        if (grid) grid.classList.remove('loading');
                    });
            }

            function debounceUpdate() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(updateMovies, 300);
            }

            // Genre dropdown toggle
            if (genreDropdownBtn && genreMenu) {
                genreDropdownBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    genreMenu.hidden = !genreMenu.hidden;
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.genre-dropdown')) {
                        genreMenu.hidden = true;
                    }
                });

                // Handle checkbox changes
                genreCheckboxes.forEach(cb => {
                    cb.addEventListener('change', () => {
                        updateGenreLabel();
                        updateMovies();
                    });
                });

                // Initialize label
                updateGenreLabel();
            }

            if (searchBox) searchBox.addEventListener('input', debounceUpdate);
            [yearFrom, yearTo, minRating, sortBy].forEach(el => {
                if (el) el.addEventListener('change', updateMovies);
            });

            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    if (searchBox) searchBox.value = '';
                    if (yearFrom) yearFrom.value = '';
                    if (yearTo) yearTo.value = '';
                    if (minRating) minRating.value = '';
                    if (sortBy) sortBy.value = 'popularity';
                    // Clear all genre checkboxes
                    genreCheckboxes.forEach(cb => cb.checked = false);
                    updateGenreLabel();
                    updateMovies();
                });
            }

            const modal = document.getElementById('movieModal');
            const modalBody = document.getElementById('modalBody');

            if (modal) {
                const modalClose = modal.querySelector('.modal-close');
                const modalBackdrop = modal.querySelector('.modal-backdrop');

                document.addEventListener('click', (e) => {
                    const card = e.target.closest('.card[data-movie-id]');
                    if (card && e.target.closest('.info-btn')) {
                        e.preventDefault();
                        const movieId = card.dataset.movieId;
                        showMovieDetails(movieId);
                    }
                });

                function showMovieDetails(movieId) {
                    modal.hidden = false;
                    if (modalBody) modalBody.innerHTML = '<div class="loading-spinner"></div>';
                    document.body.style.overflow = 'hidden';

                    fetch('/movie/' + movieId + '/detail/')
                        .then(r => r.json())
                        .then(data => {
                            if (data.success && modalBody) {
                                let html = '<div class="detail-content">';
                                if (data.backdrop_url) html += '<div class="detail-backdrop" style="background-image: url(\'' + data.backdrop_url + '\')"></div>';
                                html += '<div class="detail-info">';
                                if (data.tagline) html += '<p class="tagline">"' + data.tagline + '"</p>';

                                // Movie stats bar
                                html += '<div class="movie-stats">';
                                if (data.year) html += '<span class="stat-item">üìÖ ' + data.year + '</span>';
                                if (data.vote_average) html += '<span class="stat-item">‚≠ê ' + data.vote_average.toFixed(1) + '</span>';
                                if (data.vote_count) html += '<span class="stat-item">üëç ' + data.vote_count.toLocaleString() + ' votes</span>';
                                if (data.popularity) html += '<span class="stat-item">üî• ' + Math.round(data.popularity) + '</span>';
                                html += '</div>';

                                if (data.genres && data.genres.length) html += '<div class="genres">' + data.genres.map(function (g) { return '<span class="genre-tag">' + g + '</span>'; }).join('') + '</div>';
                                if (data.runtime) html += '<p class="runtime">üïê ' + data.runtime + ' min</p>';
                                if (data.overview) html += '<p class="overview">' + data.overview + '</p>';

                                // Director section
                                if (data.director && data.director.name) {
                                    html += '<div class="credits-section">';
                                    html += '<h4 class="credits-title">üé¨ Director</h4>';
                                    html += '<div class="director-card">';
                                    if (data.director.profile_path) {
                                        html += '<img src="' + data.director.profile_path + '" alt="' + data.director.name + '" class="person-photo">';
                                    } else {
                                        html += '<div class="person-photo no-photo">üë§</div>';
                                    }
                                    html += '<span class="person-name">' + data.director.name + '</span>';
                                    html += '</div></div>';
                                }

                                // Cast section
                                if (data.cast && data.cast.length) {
                                    html += '<div class="credits-section">';
                                    html += '<h4 class="credits-title">üé≠ Cast</h4>';
                                    html += '<div class="cast-scroll">';
                                    data.cast.forEach(function (actor) {
                                        html += '<div class="cast-card">';
                                        if (actor.profile_path) {
                                            html += '<img src="' + actor.profile_path + '" alt="' + actor.name + '" class="person-photo">';
                                        } else {
                                            html += '<div class="person-photo no-photo">üë§</div>';
                                        }
                                        html += '<span class="person-name">' + actor.name + '</span>';
                                        if (actor.character) {
                                            html += '<span class="person-role">' + actor.character + '</span>';
                                        }
                                        html += '</div>';
                                    });
                                    html += '</div></div>';
                                }

                                if (data.production_companies && data.production_companies.length) html += '<p class="production">üè¢ ' + data.production_companies.slice(0, 3).join(', ') + '</p>';
                                html += '</div></div>';
                                modalBody.innerHTML = html;
                            } else if (modalBody) {
                                modalBody.innerHTML = '<p class="error">Could not load movie details</p>';
                            }
                        })
                        .catch(function () {
                            if (modalBody) modalBody.innerHTML = '<p class="error">Error loading details</p>';
                        });
                }

                function closeModal() {
                    modal.hidden = true;
                    document.body.style.overflow = '';
                }

                if (modalClose) modalClose.addEventListener('click', closeModal);
                if (modalBackdrop) modalBackdrop.addEventListener('click', closeModal);
                document.addEventListener('keydown', function (e) {
                    if (e.key === 'Escape' && !modal.hidden) closeModal();
                });
            }
        })();
    </script>
</body>

</html>